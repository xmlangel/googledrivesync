# Dirty Tracking Guide

## `dirty`란?
- `dirty`는 "로컬 변경이 발생했지만 아직 동기화에 반영되지 않은 항목"을 뜻합니다.
- 앱에서는 `dirty_local_items` 테이블에 변경 경로를 저장해 큐처럼 사용합니다.

## 동작 흐름
1. 로컬 파일 변경 감지 (`FileObserver`)
2. `dirty_local_items`에 경로 + 이벤트 타입 기록
3. 자동/수동 동기화 시 `dirty` 항목 우선 처리 (`부분 동기화`)
4. 처리 완료된 항목만 정리

## 로그에서 보는 법
- `부분 동기화 모드 (감지된 로컬 변경 건수: N)`
  - 이번 실행 시작 시점에 큐에 있던 dirty 건수
- `동기화 중 유입 dirty 건수(partial_before_cleanup): N`
- `동기화 중 유입 dirty 건수(fullscan_before_cleanup): N`
  - 동기화 실행 중 새로 들어온 dirty 건수
  - 다음 사이클에서 처리되도록 큐에 유지됨

## 왜 "업로드 안 됨"처럼 보일 수 있나?
- 한 번의 실행에서 모든 변경을 처리하지 못하면, 나머지는 다음 사이클로 넘어갑니다.
- 특히 동기화 도중 추가 수정이 발생하면 `동기화 중 유입 dirty`로 잡히고 현재 실행에서는 처리되지 않을 수 있습니다.

## 현재 정책 요약
- 삭제 이벤트가 아닌 경우: 로컬 부재를 바로 서버 삭제로 반영하지 않음
- 서버/로컬 삭제 반영 시: 즉시 영구 삭제 대신 `conflicts_backup/deferred_delete`로 보관
- 보관본은 30일 후 자동 정리

## 점검 체크리스트
1. `dirty` 건수가 계속 증가만 하는지 확인
2. `파일 업데이트(업로드): <파일명>` 로그가 이후 사이클에 찍히는지 확인
3. 검증 리포트에 `Extra Local Files`가 남으면 다음 사이클 dirty 큐 등록 로그를 확인
