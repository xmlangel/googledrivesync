# 고급 동기화 설계 (Advanced Sync Design)

본 문서는 Google Drive Sync의 동기화 신뢰성과 효율성을 극대화하기 위한 MD5 체크섬 및 Changes API 활용 설계를 설명합니다.

## 1. MD5 체크섬 기반 데이터 무결성 검증

### 배경
현재 동기화는 '파일 이름'과 '수정 시간'을 기준으로 변경을 판단합니다. 하지만 시간만 바뀌고 내용은 그대로인 경우(예: 단순 저장 클릭) 불필요한 데이터 전송이 발생할 수 있습니다.

### 설계
- **무결성 우선 비교:** 동기화 엔진(`SyncManager.kt`)은 수정 시각이 다르더라도 MD5 해시값이 같다면 파일 내용이 변경되지 않은 것으로 판단하여 동기화를 건너뜁니다.
- **De-duplication (중복 제거):** 로컬에서 새 파일이 추가되었을 때, 서버에 동일한 MD5를 가진 파일이 이미 존재한다면 새로 업로드하지 않고 서버의 파일 고유 ID와 로컬 파일을 즉시 연결합니다.

## 2. Changes API 활용 (Differential Sync)

### 배경
수천 개의 파일이 있는 폴더에서 전체 리스팅 스캔 방식은 폴더 깊이만큼 API 호출이 발생하며 시간과 배터리를 소모합니다.

### 설계
- **Page Token 관리:** 각 동기화 폴더(`SyncFolderEntity`)는 동기화 성공 시점의 서버 상태 토큰인 `lastStartPageToken`을 로컬 DB에 저장합니다.
- **차분 동기화 과정:**
    1. 다음 동기화 시, 저장된 토큰을 사용하여 `drive.changes().list(pageToken)`를 호출합니다.
    2. 서버로부터 "마지막 토큰 이후로 바뀐 항목"만 응답받습니다.
    3. 전체 폴더를 뒤지지 않고, 응답받은 변경 항목들에 대해서만 집중적으로 업데이트를 수행합니다.
- **Folllback:** 만약 토큰이 만료되었거나 처음 동기화하는 경우 자동으로 기존의 '전체 스캔' 방식으로 전환됩니다.

## 3. 기대 효과

- **네트워크 절약:** 내용 변화가 없는 재전송 차단.
- **속도 향상:** 대규모 데이터셋에서 동기화 속도 10배 이상 향상 예상.
- **정확도:** 서버에서의 복잡한 파일 이동(Folder A -> Folder B)을 API 수준에서 정확하게 감지.
